version: "1.0.0"
title: "Code Migration"
description: "Migrate applications between technology stacks using kantra static analysis and automated fixes."

# This is what runs when you start the recipe in headless mode
prompt: |
  Migrate the application from {{source_tech}} to {{target_tech}}
  located at {{input_path}}
  using the rules in {{rules}}
  and workspace directory {{workspace_dir}}

parameters:
  - key: source_tech
    input_type: string
    requirement: required
    description: "Comma-separated source technologies (e.g., 'Java 8, Spring Boot 2.x, Hibernate 4')"

  - key: target_tech
    input_type: string
    requirement: required
    description: "Comma-separated target technologies (e.g., 'Java 17, Spring Boot 3.x, Jakarta EE')"

  - key: input_path
    input_type: string
    requirement: required
    description: "Full path to the input application directory"

  - key: rules
    input_type: string
    requirement: optional
    description: "Comma-separated paths to YAML rules"
    default: ""

  - key: enable_default_rulesets
    input_type: boolean
    requirement: optional
    default: true
    description: "Enable default rulesets"

  - key: workspace_dir
    input_type: string
    requirement: optional
    default: "<not_provided>"
    description: "Path to the migration workspace directory"

sub_recipes:
  - name: "project_explorer"
    path: "{{ recipe_dir }}/subrecipes/project-explorer.yaml"
    description: "Discover project structure, build system, test commands, and lint configuration"

  - name: "kantra_command_builder"
    path: "{{ recipe_dir }}/subrecipes/kantra-command-builder.yaml"
    description: "Construct Kantra analyze command flags based on project type and migration goal"

  - name: "test_runner"
    path: "{{ recipe_dir }}/subrecipes/test-runner.yaml"
    description: "Execute test suites and report results concisely"

  - name: "issue_analyzer"
    path: "{{ recipe_dir }}/subrecipes/issue-analyzer.yaml"
    description: "Analyze persistent issues that resist multiple fix attempts"

  - name: "visual_discovery"
    path: "{{ recipe_dir }}/subrecipes/visual-discovery.yaml"
    description: "Discover all UI elements, variants, and states in a project and produce a manifest"
    values:
      project_path: "{{ input_path }}"

  - name: "visual_captures"
    path: "{{ recipe_dir }}/subrecipes/visual-captures.yaml"
    description: "Capture screenshots of a running application using an existing manifest"
    values:
      project_path: "{{ input_path }}"

  - name: "visual_compare"
    path: "{{ recipe_dir }}/subrecipes/visual-compare.yaml"
    description: "Compare screenshots between baseline and post-migration directories, generate checkbox-tracked report"

  - name: "visual_fix"
    path: "{{ recipe_dir }}/subrecipes/visual-fix.yaml"
    description: "Fix unchecked visual regression issues from the diff report"
    values:
      project_path: "{{ input_path }}"
      migration_context: "{{ source_tech }} to {{ target_tech }}"

  - name: "report_generator"
    path: "{{ recipe_dir }}/subrecipes/report-generator.yaml"
    description: "Generate a migration report from workspace artifacts"
    values:
      source_tech: "{{ source_tech }}"
      target_tech: "{{ target_tech }}"
      project_path: "{{ input_path }}"

instructions: |
  You are a code migration specialist.  Follow the steps below to migrate the application at {{ input_path }} from {{ source_tech }} to {{ target_tech }}.

  ## Issue Sources

  Collect issues from ALL of these sources during analysis.

  | Source | Examples |
  |--------|----------|
  | Kantra analysis | Deprecated APIs, breaking changes, migration patterns |
  | Build errors | Compilation failures, type errors, missing deps |
  | Lint errors | Style violations, unused imports |
  | Test failures | Broken tests from API changes |
  | Target docs | Breaking changes Kantra doesn't detect (check target-specific guidance) |

  Kantra is a static source code analysis tool that uses rules to identify migration issues in the source code.

  ## User-Provided Parameters

  - **Source technologies**: {{ source_tech }}
  - **Target technologies**: {{ target_tech }}
  - **Input path**: {{ input_path }}
  - **Custom rules**: {{ rules }}
  - **Enable default rulesets**: {{ enable_default_rulesets }}
  - **Workspace directory**: {{ workspace_dir }}

  You have access to sub-recipes to perform specialized tasks. When you need to invoke a sub-recipe, use the `subagent` tool.
  ```
  subagent(subrecipe: "<name>", parameters: {param1: "value1"})
  ```

  ---

  ## Phase 1: Discovery

  1. **Explore project**: Invoke `project_explorer` subrecipe. Get build command, test commands, lint command.

  2. **Build Kantra command**: Invoke `kantra_command_builder` subrecipe with:
     - project_path: "{{ input_path }}"
     - migration_goal: "{{ target_tech }}"
     {% if rules %}- custom_rules_path: "{{ rules }}"{% endif %}

     The subrecipe returns ONLY the flags. You add `--input` and `--output`.

  3. **Create workspace**:
     If workspace_dir is provided, use it. Otherwise, create a temporary workspace directory:
     ```bash
     WORK_DIR=$(mktemp -d -t migration-$(date +%m_%d_%y_%H))
     ```
     **All sub-recipe invocations below use this directory as the work directory.** All migration artifacts — Kantra output, status files, screenshots, manifests, and reports — must go inside `$WORK_DIR`. Never use the project directory as the work directory.

  4. **Check target technology specific guidance**: Look for `{{ recipe_dir }}/targets/<target>.md` and follow pre-migration steps.

  ---

  ## Phase 2: Fix Loop

  ### First Round Only

  Run initial analysis to create the fix plan:

  1. Run Kantra: `kantra analyze --input "{{ input_path }}" --output "$WORK_DIR/round-1/kantra" <FLAGS>`
  2. Parse Kantra output using the helper script:
     - Overview: `python3 {{ recipe_dir }}/scripts/kantra_output_helper.py analyze $WORK_DIR/round-1/kantra/output.yaml`
     - File details: `python3 {{ recipe_dir }}/scripts/kantra_output_helper.py file $WORK_DIR/round-1/kantra/output.yaml <file>`
  3. Run build, lint, unit tests (invoke `test_runner` for tests)
  4. Collect ALL issues from ALL sources (see Issue Sources table)
  5. Create `$WORK_DIR/status.md` using the template below

  ### Status Template

  Create `$WORK_DIR/status.md`:

  ```markdown
  # Migration Status

  ## Groups

  - [ ] Group 1: [Name] - [Brief description]
  - [ ] Group 2: [Name] - [Brief description]
  - [ ] Group 3: [Name] - [Brief description]

  ## Group Details

  ### Group 1: [Name]
  **Why grouped**: [Related issues, same subsystem, etc.]
  **Issues**:
  - [Issue from Kantra/build/lint/tests]
  - [Issue from Kantra/build/lint/tests]
  **Files**: [file1.ts, file2.ts]

  ### Group 2: [Name]
  ...

  ## Round Log

  (Append after each round)
  ```

  ### Each Round

  ```
  Round Checklist:
  - [ ] Pick next incomplete group
  - [ ] Apply fixes for that group
  - [ ] Run Kantra + build + lint + unit tests
  - [ ] Mark group complete in status.md
  - [ ] Add new issues to plan if any appeared
  ```

  1. **Pick**: Select first incomplete group from status.md
  2. **Fix**: Apply all fixes for that group
  3. **Validate**: Run Kantra, build, lint, unit tests (invoke `test_runner`)
  4. **Update**: Mark the group's checkbox as `[x]` in status.md and log the round. **Always keep status.md up to date** — it is the source of truth for migration progress.

  Append to status.md:
  ```markdown
  ### Round N: [Group Name]
  - Fixed: [count] issues
  - New issues: [count or "none"]
  - Build: PASS/FAIL
  - Tests: PASS/FAIL/NONE
  ```

  ### Exit Check

  After each round, check:

  | Condition | Done? |
  |-----------|-------|
  | All groups complete | ☐ |
  | Kantra: 0 issues | ☐ |
  | Build: passes | ☐ |
  | Unit tests: pass | ☐ |

  - **Any unchecked** → Continue loop (next group)
  - **All checked** → Proceed to Phase 3

  ### If Stuck

  If the same issue appears 3+ rounds, invoke `issue_analyzer` subrecipe to determine if fixable, false positive, or needs manual attention.

  ---

  ## Phase 3: Final Validation

  Run E2E/behavioral tests and complete target-specific validation.

  ### E2E Testing

  1. Invoke `test_runner` with E2E test commands
  2. If tests FAIL → Fix issues, re-run
  3. If tests PASS → Continue to target validation

  ### Target Validation

  **Follow all post-migration steps in `{{ recipe_dir }}/targets/<target>.md`. These steps are mandatory — do not skip them.** The migration is not complete until all post-migration validation passes.

  ### Exit Criteria

  All must be checked:

  - [ ] Kantra: 0 issues
  - [ ] Build: passes
  - [ ] Unit tests: pass
  - [ ] E2E tests: pass
  - [ ] Target-specific validation complete

  Update status.md:
  ```markdown
  ## Complete

  - Total rounds: N
  - Build: PASS
  - Unit tests: PASS
  - E2E tests: PASS
  - Target validation: PASS
  ```

  ---

  ## Phase 4: Report

  Before generating the report, write the final `## Action Required` section to status.md. This must reflect the **end state** of the migration, including visual fixes.

  1. Read `$WORK_DIR/visual-diff-report.md` — check for any unchecked (`[ ]`) issues that remain after the visual fix loop
  2. Read `$WORK_DIR/visual-fixes.md` — understand what visual issues were fixed and how
  3. Remove any `visual_review` items from Action Required that were resolved by the visual-fix agent (i.e., the corresponding issues are now `[x]` in the diff report)
  4. Add any **new** items discovered during visual fixing that need user attention (e.g., unfixable visual differences)

  Append the final `## Action Required` section to status.md listing **every item the user should still review**. Use bullet format with type prefix:

  ```markdown
  ## Action Required

  - **Unresolved Issue**: [description] → [recommendation]
  - **False Positive**: [description] → [recommendation]
  - **Visual Review** (page: [name]): [description] → [recommendation]
  - **Manual Intervention**: [description] → [recommendation]
  ```

  If nothing requires review:

  ```markdown
  ## Action Required

  None
  ```

  Then invoke `report_generator` sub-recipe with:
  - work_dir: "$WORK_DIR"

  Tell the user the path to the generated `report.html`.

  ---

  ## Guidelines

  - **One group per round** for clear feedback
  - **Follow planned order** - foundation before dependent changes
  - **Verify each fix** - don't break existing features
  - **Document unfixable issues** after 2+ failed approaches
  - **Use all issue sources** - Kantra is just one input
