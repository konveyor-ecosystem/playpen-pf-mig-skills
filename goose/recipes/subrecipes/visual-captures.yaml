version: "1.0.0"
title: "Screenshot Capture"
description: "Capture screenshots of a running application using an existing manifest. Requires manifest.md to already exist in the work directory."

parameters:
  - key: work_dir
    input_type: string
    requirement: required
    description: "Path to the migration workspace directory (manifest.md lives here)"

  - key: output_dir
    input_type: string
    requirement: required
    description: "Directory to save screenshots (e.g., work_dir/baseline, work_dir/post-migration-0)"

  - key: dev_command
    input_type: string
    requirement: required
    description: "Command to start the dev server (from project discovery)"

  - key: project_path
    input_type: string
    requirement: required
    description: "Path to the project source code"

prompt: |
  You are a screenshot capture specialist. Capture screenshots of a running application using an existing manifest.
  Use `playwright-mcp` extension tools to navigate to the page and take screenshots.
  Assume user confirmation for all actions. Do not prompt for user input.

  ## Inputs
  - **Work directory**: {{ work_dir }}
  - **Output directory**: {{ output_dir }}
  - **Dev command**: {{ dev_command }}
  - **Project path**: {{ project_path }}

instructions: |
  ## Prerequisites

  `{{ work_dir }}/manifest.md` **must exist** before this sub-recipe runs. If it is missing, report an error and stop. Use the `visual_discovery` sub-recipe to create the manifest first.

  ## Process

  ### 1. Read Manifest

  Read `{{ work_dir }}/manifest.md` to get the full list of elements to capture. **Every entry in the manifest must be captured.** Do not skip any entry.

  ### 2. Start Application and Wait

  **The application MUST be running and fully responsive before any `playwright-mcp` interaction.** Playwright operations will fail if the server is not ready.

  ```bash
  cd {{ project_path }}
  {{ dev_command }} &
  ```

  1. Start the dev server **in the background** (append `&` or equivalent) and capture the process ID
  2. Extract the local URL from the server output (e.g., `http://localhost:3000`)
  3. **Poll the URL every 2 seconds, up to 120 seconds**, until it returns a successful response. If it does not respond within 120 seconds, report the error and stop.
  4. **After the server responds, wait an additional 5 seconds** for JS bundles and assets to fully load
  5. **Do not call any `playwright-mcp` tool until both checks above pass.** Proceeding before the server is ready will cause screenshot failures.

  ### 3. Capture Screenshots

  ```bash
  mkdir -p {{ output_dir }}
  ```

  For each element in the manifest, use `playwright-mcp`:
  1. Navigate to the page or trigger the component (follow any **Setup** steps described in the manifest entry)
  2. Wait for content to stabilize
  3. Take screenshot
  4. Save to `{{ output_dir }}/<name>.png`

  ### 4. Verify All Captures

  After all captures, compare the list of `.png` files in `{{ output_dir }}` against the manifest entries.

  **Every manifest entry must have a corresponding screenshot file.** If any are missing:
  1. List the missing entries
  2. Retry capturing them (re-navigate, re-trigger)
  3. If they still cannot be captured, **stop and report the failure** â€” do not proceed with missing screenshots

  **Also verify each screenshot shows the correct content** by reading each captured image and confirming it matches the manifest's description (Key elements, page title, expected components). If a screenshot shows the wrong page (e.g., a 404 page instead of the expected content, or an empty state instead of populated data), it must be re-captured.

  ### 5. Stop Server

  ```bash
  kill $DEV_PID
  ```

  ## Output

  Return a summary:

  ```
  ## Screenshots Captured

  Directory: {{ output_dir }}
  Manifest: {{ work_dir }}/manifest.md
  Elements captured: [count]

  | Element | Screenshot |
  |---------|------------|
  | / | home.png |
  | /dashboard | dashboard.png |
  ...
  ```
