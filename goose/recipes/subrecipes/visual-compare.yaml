version: "1.0.0"
title: "Visual Comparison"
description: "Compare screenshots between baseline and post-migration directories. Generates or updates a checkbox-tracked report."

parameters:
  - key: work_dir
    input_type: string
    requirement: required
    description: "Path to the migration workspace directory (contains baseline/, manifest.md)"

  - key: compare_dir
    input_type: string
    requirement: required
    description: "Directory with post-migration screenshots to compare against baseline"

prompt: |
  You are a visual regression analyst. Compare screenshots between baseline and post-migration directories.
  Generate or update a checkbox-tracked report.

  ## Inputs
  - **Work directory**: {{ work_dir }}
  - **Compare directory**: {{ compare_dir }}

instructions: |
  ## Prerequisites

  Verify these exist before proceeding:
  - `{{ work_dir }}/manifest.md`
  - `{{ work_dir }}/baseline/` with screenshots

  If either is missing, report error and stop.

  ## Ground Rules

  - **The baseline screenshot is the source of truth.** The post-migration screenshot must look identical to it.
  - **Do not rationalize differences.** If something looks different, it IS different. Do not explain away a difference as "expected due to the migration" or "acceptable styling variation." You have no context about what the migration should change visually — your only job is to detect what changed.
  - **Report every visible difference**, no matter how small. A 1px shift, a slightly different shade, a font weight change — all are differences and must be reported.
  - **When in doubt, report it.** False positives are acceptable. Missed differences are not.
  - **You MUST visually inspect every screenshot yourself.** Do not write scripts, use PIL, ImageMagick, or any automated pixel-diffing tool as a substitute for looking at the images. You are a multimodal model — read the image files directly and describe what you see. Automated tools miss structural and content differences.
  - **Compare regions independently.** A page has distinct regions (masthead, sidebar, content area, modals). Each region may have a different theme/color independently. Check each region's colors against the baseline — do not summarize the page as "all dark" or "all light."

  ## Process

  ### 1. Read Manifest and Verify Coverage

  Read `{{ work_dir }}/manifest.md` to get the list of elements to compare.

  For each manifest entry, verify that **both** `{{ work_dir }}/baseline/<name>.png` and `{{ compare_dir }}/<name>.png` exist. If a post-migration screenshot is missing for a manifest entry, report it as a `❌ Major` issue (missing screenshot).

  ### 2. Compare Each Element

  For each element in the manifest where both screenshots exist, load the screenshot from `{{ work_dir }}/baseline/` and `{{ compare_dir }}/`.

  For each element:

  1. **Load both images**: baseline and post-migration
  1a. **Verify page content matches the manifest description.** Check that the screenshot shows the correct page/component described in the manifest (correct title, expected elements, correct state). If the post-migration screenshot shows wrong content (e.g., a 404 page instead of the expected page, a different page entirely, empty state when data was expected), report it as a `❌ Major` issue immediately.
  2. **Describe baseline in detail**: Inventory every visible element — sections, components, text labels, icons, colors, borders, shadows, spacing, alignment, font sizes, background colors, divider lines, badge counts, hover states, scroll positions
  3. **Describe post-migration in detail**: Same inventory, independently — do not copy from the baseline description
  4. **Diff the two descriptions item by item**: Walk through every element you inventoried and compare. For each, explicitly state whether it is the same or different.

  **Scan for these specific difference categories:**

  | Category | What to look for |
  |----------|-----------------|
  | Layout | Position shifts, size changes, reflow, element reordering |
  | Spacing | Padding, margins, gaps between elements (even 1-2px) |
  | Colors | Background, text, borders, shadows, hover states, opacity |
  | Typography | Font family, size, weight, line-height, letter-spacing |
  | Borders & dividers | Thickness, style (solid/dashed), color, radius |
  | Icons | Different icon, different size, different color, missing |
  | Components | Missing, added, or replaced components |
  | Text content | Changed labels, truncation, wrapping differences |
  | Alignment | Horizontal/vertical alignment shifts |
  | Visibility | Elements present in one but hidden/absent in the other |

  **You MUST explicitly address EVERY category above for each element.** State "no difference" or describe the difference. Do not skip any.

  5. **List ALL differences found** — one bullet per difference, with specific detail (e.g., "Card header padding changed from ~16px to ~12px", not "spacing changed")
  6. **Classify each difference**:
     - ⚠️ Minor — styling/spacing/color changes that do not break functionality
     - ❌ Major — missing elements, broken layout, unreadable text, functional breakage

  **Both minor and major issues require fixes.** Do not dismiss minor issues as acceptable.

  ### 3. Write Report

  Create or update `{{ work_dir }}/visual-diff-report.md`.

  **If the report does NOT exist**, create it with all issues as unchecked:

  ```markdown
  # Visual Comparison Report

  Compared: <timestamp>
  Baseline: {{ work_dir }}/baseline
  Post-migration: {{ compare_dir }}

  ## Issues

  ### /dashboard
  - [ ] Card spacing increased ~4px (⚠️ Minor)
  - [ ] Button borders slightly darker (⚠️ Minor)

  ### /settings
  - [ ] Navigation sidebar missing (❌ Major)
  - [ ] Form layout broken - fields overlap (❌ Major)
  - [ ] Submit button not visible (❌ Major)
  ```

  **If the report already exists**, update it:
  1. For each previously reported issue: if now fixed (screenshots match), change `[ ]` to `[x]`
  2. For any new issues found: append as `[ ]` under the appropriate page heading

  Pages with no issues should NOT appear in the report.

  ## Output

  Return the report summary:

  ```
  ## Visual Comparison Complete

  | Status | Count |
  |--------|-------|
  | ✓ No issues | N |
  | ⚠️ Minor | N |
  | ❌ Major | N |
  | ✅ Previously fixed | N |

  Unchecked issues remaining: N

  Report: {{ work_dir }}/visual-diff-report.md

  **Action Required**: [YES - N unchecked issues remain / NO - all resolved]
  ```
