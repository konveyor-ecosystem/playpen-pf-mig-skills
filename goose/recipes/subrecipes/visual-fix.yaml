version: "1.0.0"
title: "Visual Fix"
description: "Fix unchecked visual regression issues from the diff report. Marks items fixed and maintains a fix log."

parameters:
  - key: work_dir
    input_type: string
    requirement: required
    description: "Path to the migration workspace directory"

  - key: dev_command
    input_type: string
    requirement: required
    description: "Command to start the dev server"

  - key: project_path
    input_type: string
    requirement: required
    description: "Path to the project source code"

  - key: migration_context
    input_type: string
    requirement: required
    description: "Brief 2-3 line summary of the ongoing migration — what technologies are involved and what has been done so far"

  - key: post_migration_dir
    input_type: string
    requirement: required
    description: "Path to the current post-migration screenshot directory (e.g., work_dir/post-migration-0)"

prompt: |
  You are a visual regression fixer. Fix unchecked visual issues from the diff report.
  Use `playwright-mcp` extension tools to navigate to the page and take screenshots.
  Assume user confirmation for all actions. Do not prompt for user input.

  ## Inputs
  - **Work directory**: {{ work_dir }}
  - **Post-migration directory**: {{ post_migration_dir }}
  - **Dev command**: {{ dev_command }}
  - **Project path**: {{ project_path }}
  - **Migration context**: {{ migration_context }}

instructions: |
  ## Ground Rules

  - **The baseline screenshot is the source of truth.** The goal is to make post-migration screenshots look identical to baseline. Do not decide that a difference is "acceptable" or "expected."
  - **Do not rationalize differences.** If the baseline shows X and the current screenshot shows Y, that is a difference to fix — regardless of whether the migration "should" have changed it.
  - **Every reported issue must be fixed.** Do not close an issue as "won't fix" or "by design." If it looks different from baseline, it needs a code change.
  - **Verify fixes against baseline, not against your expectations.** After making a fix, compare the new screenshot to the baseline screenshot — not to what you think it should look like.

  ## Process

  ### 1. Understand Context

  Read `{{ work_dir }}/status.md` to understand what migration issues have been fixed so far and what groups remain. This helps identify root causes of visual regressions.

  ### 2. Read Report

  Read `{{ work_dir }}/visual-diff-report.md`. Collect all unchecked (`[ ]`) issues.

  If no unchecked issues exist, report success and stop.

  ### 3. Fix Loop (per page)

  Group unchecked issues by page. Maintain a round counter starting at 0.

  For each fix attempt, create a round directory: `{{ work_dir }}/visual-fix-round-N/` (increment N each attempt).

  For each page:

  1. **Analyze**: Load the baseline screenshot and the current screenshot for this page. Describe what is different — do not assume you already know from the report alone; look at the actual images.
  2. **Identify cause**: Look at the code for this page/component, find what changed. Trace the visual difference to a specific code change (CSS property, component prop, class name, design token, etc.).
  3. **Fix**: Make code changes to resolve the visual differences. The fix must make the current rendering match the baseline — not some other "correct" state.
  4. **Verify**:
     **The application MUST be running and fully responsive before any `playwright-mcp` interaction.** Playwright operations will fail if the server is not ready.
     - Start the app **in the background** and capture the process ID:
       ```bash
       cd {{ project_path }}
       {{ dev_command }} &
       ```
     - **Poll the URL every 2 seconds, up to 120 seconds**, until it returns a successful response. If it does not respond within 120 seconds, report the error and stop.
     - **After the server responds, wait an additional 5 seconds** for JS bundles and assets to fully load
     - **Do not call any `playwright-mcp` tool until both checks above pass.**
     - Use `playwright-mcp` to navigate to the page, take a new screenshot, and save it to `{{ work_dir }}/visual-fix-round-N/<name>.png`
     - Compare the new screenshot against the **baseline** screenshot to verify the issues are fixed. Do not compare against the previous post-migration screenshot.
     - Stop the app
  5. **Iterate**: If the issue persists (the new screenshot still differs from baseline), increment the round counter, try a different approach. Keep trying until fixed.
  6. **Update immediately** after each page — **write `visual-fixes.md` first**, before any other update, so partial progress is preserved if the agent fails midway:
     - **First**: append a brief (2-3 line) summary to `{{ work_dir }}/visual-fixes.md` describing what was changed and why (or noting the issue was unfixable and why)
     - Copy the verified screenshot to the post-migration directory: `cp {{ work_dir }}/visual-fix-round-N/<name>.png {{ post_migration_dir }}/<name>.png`
     - Mark fixed issues as `[x]` in `{{ work_dir }}/visual-diff-report.md`

  Do not wait until all pages are done — update all files after every page so progress is visible.

  ### 4. Fix Log Format

  Maintain `{{ work_dir }}/visual-fixes.md` with brief entries per page:

  ```markdown
  # Visual Fixes

  ## /dashboard
  Replaced deprecated `pf-v5-u-m-lg` class with `pf-v6-u-m-lg` in DashboardCards.tsx.
  Updated border token `--pf-v5-global--BorderColor` to v6 equivalent.

  ## /settings
  Re-added `PageSidebar` import that was removed during migration.
  Replaced deprecated `Grid` span props with new `GridItem` API in SettingsForm.tsx.
  ```

  ## Output

  Return summary:

  ```
  ## Visual Fix Complete

  Issues fixed: N
  Issues remaining: N

  ### Fixes Applied
  - /dashboard: 2 issues fixed
  - /settings: 3 issues fixed

  Report: {{ work_dir }}/visual-diff-report.md
  Fix log: {{ work_dir }}/visual-fixes.md

  **All visual issues resolved**: [YES/NO]
  ```
